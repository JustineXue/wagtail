name: Local Test Suite

on:
  push:
    branches:
      - '**'  # Trigger on any branch push
  pull_request:
    branches:
      - main
  workflow_dispatch:  # Allow manual triggering

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e '.[testing]' --config-settings editable_mode=strict
        pip install 'Django>=5.2,<5.3'
        pip install coverage

    - name: Run Python unit tests (Django)
      id: python_tests
      continue-on-error: true
      run: |
        set -o pipefail
        export PYTHONUNBUFFERED=1
        WAGTAIL_FAIL_ON_VERSIONED_STATIC=1 DJANGO_SETTINGS_MODULE=wagtail.test.settings django-admin check 2>&1 | tee test-output-python-check.txt || true
        coverage run --parallel-mode --source wagtail runtests.py --parallel 2>&1 | tee test-output-python.txt
      env:
        DATABASE_ENGINE: django.db.backends.sqlite3
        WAGTAIL_CHECK_TEMPLATE_NUMBER_FORMAT: '1'

    - name: Generate comprehensive test summary
      if: always()
      run: |
        # Parse Python test results from output file
        python_total=0
        python_passed=0
        python_failed=0
        python_errors=0
        python_skipped=0
        
        if [ -f test-output-python.txt ]; then
          if grep -q "Ran.*test" test-output-python.txt; then
            python_total=$(grep -oE "Ran [0-9]+ test" test-output-python.txt | grep -oE "[0-9]+" | head -1 || echo "0")
            python_failed=$(grep -oE "failures=[0-9]+" test-output-python.txt | grep -oE "[0-9]+" | head -1 || echo "0")
            python_errors=$(grep -oE "errors=[0-9]+" test-output-python.txt | grep -oE "[0-9]+" | head -1 || echo "0")
            python_skipped=$(grep -oE "skipped=[0-9]+" test-output-python.txt | grep -oE "[0-9]+" | head -1 || echo "0")
            python_passed=$((python_total - python_failed - python_errors - python_skipped))
          fi
        fi
        
        total_tests=$python_total
        total_passed=$python_passed
        total_failed=$python_failed
        total_errors=$python_errors
        total_skipped=$python_skipped
        
        # Create test summary markdown
        cat > test-summary.md << EOF
        # Test Results Summary
        
        Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        
        ## Overall Summary
        
        | Metric | Count |
        |--------|-------|
        | **Total Tests** | $total_tests |
        | **Passed** | $total_passed |
        | **Failed** | $total_failed |
        | **Errors** | $total_errors |
        | **Skipped** | $total_skipped |
        
        ## Python Unit Tests (Django)
        
        | Metric | Count |
        |--------|-------|
        | **Total Tests** | $python_total |
        | **Passed** | $python_passed |
        | **Failed** | $python_failed |
        | **Errors** | $python_errors |
        | **Skipped** | $python_skipped |
        
        ## Test Execution Details
        - Django system check: $(if [ -f test-output-python-check.txt ] && grep -q "System check identified" test-output-python-check.txt; then echo "✅ Completed"; else echo "⚠️ Status unknown"; fi)
        - Test execution: $(if [ -f test-output-python.txt ] && grep -q "Ran.*test" test-output-python.txt; then echo "✅ Completed"; else echo "⚠️ Status unknown"; fi)
        
        ## Notes
        - Python tests run against SQLite database
        - Test output captured in test-output-python.txt and test-output-python-check.txt
        
        EOF
        
        # Also create a plain text version
        cat > test-output.txt << EOF
        TEST RESULTS SUMMARY
        ====================
        Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        
        OVERALL SUMMARY
        ---------------
        Total Tests: $total_tests
        Passed: $total_passed
        Failed: $total_failed
        Errors: $total_errors
        Skipped: $total_skipped
        
        PYTHON UNIT TESTS (Django)
        --------------------------
        Total: $python_total
        Passed: $python_passed
        Failed: $python_failed
        Errors: $python_errors
        Skipped: $python_skipped
        
        EOF
        
        # Display summary
        cat test-summary.md
        echo ""
        echo "=========================================="
        echo "Plain text summary saved to test-output.txt"
        echo "=========================================="

    - name: Upload test reports and outputs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports
        path: |
          test-summary.md
          test-output.txt
          test-output-python.txt
          test-output-python-check.txt
          .coverage.*
        if-no-files-found: ignore
        retention-days: 30

    - name: Display test summary
      if: always()
      run: |
        echo "## Test Summary" >> $GITHUB_STEP_SUMMARY
        cat test-summary.md >> $GITHUB_STEP_SUMMARY